import { access, cp, rm } from 'fs/promises';
import { resolve } from 'path';
import { getAssignmentSubFolderPath, readAssigmentPackageJson } from './utils.js';

/** Copy all needed files and folder into the project root folder */
export default async function init() {
  const packageJson = await readAssigmentPackageJson();
  for (const fileOrfolder of packageJson.files) {
    await copyItemToRoot(fileOrfolder);
  }
}

/** Copy folder or file from @plugga-tech package to project root */
async function copyItemToRoot(itemName) {
  const target = await getAssignmentSubFolderPath(itemName);
  const destination = resolve(itemName);

  if (itemName.match(/(.pluggarc|plugga.config)/g)) {
    try {
      // Config file must only be copied once,
      // since it's meant to be edited by the user.
      return await access(destination);
    } catch (error) {}
  }

  try {
    try {
      await rm(destination, { recursive: true });
    } catch (error) {}
    await cp(target, destination, { recursive: true });
  } catch (error) {
    console.error(error);
  }
}
